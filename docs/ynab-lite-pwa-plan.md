# План разработки: YNAB‑lite PWA (iPhone SE 2022 + Web)

**Версия:** 1.0 • **Дата:** 2025-10-21
**Стиль:** Tailwind (минимализм) • **Подход:** Local‑first (без бэкенда на старте) • **Язык:** JS/TS (рекомендуется TS)

## 0) Текущее состояние (2025-11-19)
- Общий прогресс: **≈90 % выполнено**. Stage 0–4 завершены, Stage 5 (тесты/полировка/a11y) — в активной работе.
- Таблица статусов отражает актуальный фокус:

| Этап | Описание | Статус | Прогресс |
| --- | --- | --- | --- |
| 0 | Скелет (Nuxt + Tailwind + PWA) | ✅ | 100 % |
| 1 | Данные и CRUD | ✅ | 100 % |
| 2 | Транзакции и расчёты | ✅ | 100 % |
| 3 | PWA и офлайн‑проверка | ✅ | 100 % |
| 4 | JSON бэкап/импорт | ✅ | 100 % |
| 5 | Полировка UI/A11y и тесты | ▶️ | 50 % |

- Ближайший фокус: Stage 5 — покрыть `MoneyInput`, сторы и репозитории `accounts`/`categories`, собрать smoke add→filter→export→import, и отточить пустые состояния + a11y.
- Выявленные пробелы:
  - smoke add→filter→export→import ещё не прогонялся в Vitest/ручном режиме;
  - ручного подтверждения iOS install/offline (iPhone SE) пока не было — нужно проверить service worker + AddToHomeBanner;
  - нет unit-покрытия для `MoneyInput`, `accounts`/`categories` store/репо и backup import UI flow.

## Текущие задачи Stage 5
- **Тесты & валидации:** покрыть `components/MoneyInput.vue`, сторы/репозитории `accounts` и `categories`, входящие формы и backup import flow, добавить unit-тесты на ключевые контракты.
- **Smoke add→filter→export→import:** прогнать сценарий (Vitest или ручной smoke) с реальным snapshot, убедиться, что фильтры/балансы не ломаются, и зафиксировать результат.
- **Empty states и a11y:** улучшить подсказки/CTA на dashboard/transactions/forms, проверить фокус/aria-описания, удостовериться в клавиатурных маршрутах.
- **Device smoke:** вручную подтвердить установка/офлайн на iPhone SE (Safari), проверить скрытие `AddToHomeBanner` и работу service worker, записать наблюдения в `docs/status.md`.

### Параллельные дорожки
- **Device smoke:** ручное подтверждение iOS install/offline (iPhone SE), Lighthouse check, и запись результатов в `docs/status.md`.
- **JSON backup/import:** функциональность готова, но нужен smoke и подтверждение предупреждения/предпросмотра.
- **Тесты/полировка:** покрытие MoneyInput/store/репо, smoke add→filter→export→import, empty states и a11y продолжаются.

## План работ (Roadmap — рядом с текущим состоянием)

### Этап 2 — Транзакции и расчёты (2–4 дн.)
- [ ] Маска MoneyInput + быстрые суммы (компонент + интеграция в форму транзакции).
- [ ] Дашборд: общий и поканальный баланс, пустые состояния, CTA к созданию счетов/категорий/транзакций.

**Browser MVP (текущий фокус):** Этапы 0–2. После их завершения приложение уже полностью работает в браузере (CRUD, фильтры, поиск) и может использоваться без офлайн-установки.

### Этап 3 — PWA и офлайн (1 дн.)
- [ ] Кэш ассетов/роутов, офлайн‑тест на iPhone SE.
- [ ] «Добавить на Домой» (iOS инструкции).

### Этап 4 — Бэкап (0.5–1 дн.)
- [ ] Экспорт JSON (версионированный).
- [ ] Импорт JSON (валидации, предпросмотр, подтверждение).

### Этап 5 — Полировка (1–2 дн.)
- [ ] Пустые состояния, мелкие анимации.
- [ ] Улучшение доступности (A11y).

> **Итого MVP:** 1–2 недели спокойной сборки одним разработчиком. Переход к Этапам 3–5 планируется после завершения Browser MVP.

---

## 1) Цели MVP
- Вести **доходы/расходы**.
- Видеть **остаток денег**: по счёту и общий.
- **Категории** (базовые + пользовательские).
- **Фильтры** по дате/категории/счёту, **поиск**.
- **Экспорт/импорт** данных в JSON.
- Работает **офлайн** как PWA на iPhone SE 2022 (и в браузере).

**Вне MVP (на потом):** синхронизация между устройствами, авторизация, бюджеты «каждый рубль занят», планировщик, напоминания, отчёты/графики, мультивалюта.

---

## 2) Ключевые пользовательские сценарии
1. **Добавить расход/доход**: выбрать счёт, сумму, категорию, дату, заметку → сохранить.
2. **Посмотреть остаток**: открыть «Дашборд» → общий баланс и балансы счетов.
3. **Найти операции**: фильтры по периоду/категории/счёту + поиск по заметке.
4. **Настроить категории**: включить дефолтные, добавить свои.
5. **Бэкап/восстановление**: выгрузить JSON, импортировать JSON.

---

## 3) Технический стек (MVP)
- **Framework:** Nuxt 4 (Vue 3 + Vite).
- **Стили:** Tailwind CSS (минимальные утилити‑классы).
- **State:** Pinia.
- **Локальная БД:** IndexedDB через **Dexie.js**.
- **PWA:** `@vite-pwa/nuxt` (Service Worker, манифест, офлайн‑кеш).
- **Дата/время:** `date-fns` (легко и локализуемо).
- **Валидации:** трёхуровневая стратегия — модели описываем в TypeScript, каждая пользовательская форма/экшен проходит Zod-схему перед записью, а JSON экспорт/импорт валидируется строгой Zod-схемой с проверкой `version`.
- **Формат денег:** целые «минорные» единицы (копейки).

> **Почему так:** одна кодовая база для iPhone SE и веб; офлайн‑устойчивость; быстрый старт; минимум зависимостей.

---

## 4) Архитектура (Local‑first)
- Все данные хранятся **локально** (IndexedDB). Никакого сервера в MVP.
- **Экспорт/импорт JSON** — способ переносить данные/делать бэкапы.
- Расчёты балансов — **деривативные селекторы** (не дублируем суммы).
- Денежные значения — **целые числа в копейках** (избегаем ошибок float).
- Практики: Clean Architecture-lite (Uncle Bob) — разделяем Dexie (данные), Pinia/composables (домен), Nuxt-компоненты (UI); SOLID/GRASP применяем точечно, Dexie оборачиваем в репозитории (Ports & Adapters), бизнес-логика оформлена как функциональное ядро + императивная оболочка.

**На будущее (синк):**
- Добавить лёгкий бэкенд (Supabase или Cloudflare Workers + D1).
- Эндпоинт `/sync` с LWW‑стратегией (last‑write‑wins по `updatedAt`).

---

## 5) Модель данных (минимум)

```ts
// money в «копейках» (integer)
type MoneyMinor = number; // напр. 1999 = 19.99 ₽

// Счёт (карта, наличные, банк)
interface Account { 
  id: string;
  name: string;
  type: 'cash' | 'card' | 'bank';
  currency: 'RUB';          // MVP — одна валюта
  createdAt: string;        // ISO
  archived?: boolean;
}

// Категория
interface Category {
  id: string;
  name: string;
  type: 'income' | 'expense';
  isDefault?: boolean;
  archived?: boolean;
}

// Транзакция
interface Transaction {
  id: string;
  accountId: string;
  type: 'income' | 'expense';
  amountMinor: MoneyMinor;  // всегда целые минорные единицы
  categoryId: string;
  note?: string;
  date: string;             // ISO (локальная дата операции)
  createdAt: string;        // ISO
  updatedAt: string;        // ISO
}
```

**Индексы (Dexie):** по `accountId`, `date`, `categoryId`, `type`.

---

## 6) Экспорт/импорт JSON (спецификация)

```json
{
  "version": 2,
  "exportedAt": "2025-10-21T00:00:00.000Z",
  "accounts": [ { "id": "acc_...", "name": "Кошелёк", "type": "cash", "currency": "RUB", "createdAt": "..." } ],
  "categories": [ { "id": "cat_food", "name": "Еда", "type": "expense", "isDefault": true } ],
  "transactions": [ { "id": "txn_...", "accountId": "acc_...", "type": "expense", "amountMinor": 15900, "categoryId": "cat_food", "note": "обед", "date": "2025-10-21", "createdAt": "...", "updatedAt": "..." } ],
  "categoryAssignments": [ { "id": "asgn_...", "month": "2025-10", "categoryId": "cat_food", "assignedMinor": 50000, "createdAt": "...", "updatedAt": "..." } ]
}
```

**Правила импорта:**  
- `version` поддерживается для миграций.  
- Импорт **полностью заменяет** таблицы Dexie (без авто‑слияния), чтобы снапшот точно соответствовал JSON.  
- «Умное слияние» по `id` с подтверждением конфликтов — потенциальная опция позже.

---

## 7) Экраны и UX (iPhone SE 2022)
1. **Дашборд**: общий баланс, список счетов (balance badge), «+» (новая транзакция).
2. **Транзакции**: список, фильтры (период/счёт/категория), поиск по заметке.
3. **Новая/Редактировать**: тип (доход/расход), сумма, счёт, категория, дата, заметка.
4. **Категории**: дефолтные + пользовательские (добавить/архивировать).
5. **Настройки**: экспорт/импорт, валюта (RUB), сброс демо‑данных.

**Навигация:** нижний таб‑бар (4–5 вкладок). **Размеры:** крупные тапы (44px), без перегруза.  
**Ввод суммы:** цифровая клавиатура, маска с 2 знаками.  
**Пустые состояния:** дружелюбные подсказки + быстрые действия.

---

## 8) Состояние и бизнес‑правила
- Pinia‑сторы: `accounts`, `categories`, `transactions`, `ui`.
- Селекторы: баланс по счёту, общий баланс, суммы по категориям/периоду.
- Валидации при сохранении: сумма > 0, валидные связи account/category.
- Редактирование/удаление транзакции — пересчитывает производные селекторы.
- Архивация категории/счёта не ломает историю (только скрывает из форм).

---

## 9) Структура проекта (Nuxt 4 + Tailwind)

```
/app
  /assets
  /composables
    useMoney.ts        # форматирование/парсинг
    useFilters.ts
  /db
    client.ts          # схема БД, индексы, миграции
    seed.ts
  /repositories
  /types
/components
/layouts
/pages
/public
/stores
/tests
app.vue
nuxt.config.ts
tailwind.config.ts
```

---

## 10) План работ (Roadmap)

Чек-листы отражают, что Stage 0–4 завершены, а Stage 5 — в процессе:

| Этап | Статус | Основные задачи |
| --- | --- | --- |
| 2 | ✅ | MoneyInput, транзакции, дашборд/балансы |
| 3 | ✅ | Manifest, Workbox, OfflineIndicator, AddToHomeBanner |
| 4 | ✅ | Версионированный JSON export/import с settings UI |
| 5 | ▶️ | 1) Unit coverage (MoneyInput, accounts/categories store/repo, validation).<br>2) Smoke add→filter→export→import (Vitest/ручной).<br>3) Empty states + a11y и manual iOS PWA smoke |

---

## 11) Команды проекта (источник истины)

Команды dev/build/test/lint берём из `package.json` и `README.md` (секция Common tasks),
чтобы не дублировать и не устаревать.

---

## 12) Критерии готовности (DoD)
- Все сценарии из §2 выполняются офлайн.
- База не «ломается» при редактировании/удалении.
- Экспорт/импорт JSON отрабатывает без потерь.
- Lighthouse PWA: **Installable** + офлайн OK.
- TTI на iPhone SE < 2.5 c при тёплом старте (ориентир).

---

## 13) Тестирование
- **Слой 1 (unit):** `useMoney`, нормализация дат/ввода, любые чистые helper'ы, которые затрагивают деньги/фильтры.
- **Слой 2 (store/validators):** Pinia селекторы для балансов/поиска плюс Zod-схемы форм/JSON импорта (happy + error cases) — главное место для регрессии.
- **Слой 3 (smoke E2E):** один сценарий добавить→отфильтровать→экспорт→импорт, прогоняемый on-demand/перед релизом, чтобы покрыть Nuxt+Dexie+PWA связку.
- Smoke на iPhone SE (Safari): холодный/тёплый старт, офлайн.

---

## 14) Деплой
- **Статический хостинг:** Cloudflare Pages / Netlify / Vercel.
- Требуется HTTPS‑origin для PWA.
- Версионируем схему (миграции Dexie) при релизах.

---

## 15) Следующие фазы (после MVP)
- **Синхронизация**: Supabase (Postgres + Auth) или Cloudflare Workers + D1.
- **Auth:** Magic link / Passkeys.
- **Бюджеты** (YNAB‑логика распределения средств).
- **Планировщик** и «запланированные транзакции».
- **Отчёты**: по категориям/месяцам, кэшируемые агрегации.
- **Мультивалюта** и курсы (локальные кэши).

---

## 16) Риски и решения
- **Потеря данных пользователем:** регулярный **экспорт JSON** (подсказки в UI).
- **iOS PWA ограничения:** протестировать storage quota; избегать больших бинарников.
- **Миграции Dexie:** сохранять `version` экспорта, писать миграции idempotent.
- **Формат денег:** только целые «minor units», Money helpers обязательны.

---

## 17) Набор дефолтных категорий (пример)
**Расходы:** Еда, Транспорт, Жильё, Коммунальные, Связь, Одежда, Здоровье, Развлечения, Путешествия, Образование, Подарки, Прочее.  
**Доходы:** Зарплата, Фриланс, Проценты, Подарки, Прочее.

---

## 18) Полезные утилиты (эскизы)

```ts
// useMoney.ts
export function toMinor(input: string): number {
  // "19,99" | "19.99" -> 1999
  const normalized = input.replace(',', '.').trim();
  const [int, frac=''] = normalized.split('.');
  const frac2 = (frac + '00').slice(0, 2);
  return Number(int) * 100 + Number(frac2);
}
export function fromMinor(minor: number): string {
  const sign = minor < 0 ? '-' : '';
  const abs = Math.abs(minor);
  const rub = Math.floor(abs / 100);
  const kop = String(abs % 100).padStart(2, '0');
  return `${sign}${rub}.${kop}`;
}
```

```ts
// client.ts (эскиз)
import Dexie, { Table } from 'dexie';

export interface DBSchema extends Dexie {
  accounts: Table<Account, string>;
  categories: Table<Category, string>;
  transactions: Table<Transaction, string>;
}

export const db = new Dexie('ynab_lite') as DBSchema;

db.version(1).stores({
  accounts: 'id, name, type, createdAt',
  categories: 'id, name, type',
  transactions: 'id, accountId, categoryId, type, date'
});
```
---

**Готово к старту.** С этого плана можно сразу инициализировать репозиторий и приступить к сборке MVP.
